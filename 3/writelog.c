#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int check_blacklist(char * str);

int main(int argc, char * argv[])
{
	if (argc != 2)
	{
		printf("Usage: %s MESSAGE\n", argv[0]);
		return 1;
	}

	if (!check_blacklist(argv[1]))
	{
		char cmd[256];
		snprintf(cmd, sizeof(cmd), "/bin/echo %s >> /home/rotorooter/sensitive.log", argv[1]);
		printf("Nothing suspicious detected. Writing harmless message to log...\n");
		char * args[] = { "/bin/sh", "-p", "-c", cmd, NULL };
		execv(args[0], args);
	}
	else
	{
		printf("Attack thwarted. Reporting incident to Santa.\n");
		//notify_santa(); // TODO
	}
	return 0;
}

int check_blacklist(char * str)
{
	char * blacklist;

	blacklist = (char *)malloc(15);
	blacklist[0] = '&';
	blacklist[1] = '$';
	blacklist[2] = '/';
	blacklist[3] = '(';
	blacklist[4] = ')';
	blacklist[5] = ';';
	blacklist[6] = '|';
	blacklist[7] = '-';
	blacklist[8] = '<';
	blacklist[9] = '>';
	blacklist[10] = '\\';
	blacklist[11] = '#';
	blacklist[12] = '%';
	blacklist[13] = '\n';
	blacklist[14] = '\0';

	if (strlen(str) > 70)
	{
		printf("String is too long! Aborting.\n");
		return 1;
	}

	char buf[102];
	snprintf(buf, sizeof(buf), "Check for blacklisted chars:\n\t%.70s\n", str);
	printf(buf);

	const char *c = str;
	int found_char = 0;
	while (*c)
	{
		if (strchr(blacklist, *c))
		{
			printf("\033[1m\033[31m\033[%ldC^\r\033[0m", 8+c-str);
			found_char = 1;
		}
		c++;
	}
	printf("\n");

	free(blacklist);

	return found_char;
}