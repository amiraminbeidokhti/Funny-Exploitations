/* A simple program that automatically grades you.
 * It would appear that you all fail, unfortunately.
 * Better luck next time. */
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <pwd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(int argc, char * argv[])
{
	uid_t uid;
	struct passwd *pw;
	FILE *fout, *fin;
	char output_filename[32 + strlen("/submit/") + 1];
	char input_filename[] = "./user_comments";
	char message[] = "Dear TA, please award %1$s a big, fat *FAIL* for this problem. A comment consisting of %2$d chars from %1$s follows: %3$s\n";
	char buffer[256];
	size_t buffer_len, bytes_read, bytes_written;

	uid = getuid();
	pw = getpwuid(uid);
	if (pw == NULL)
	{
		perror("getpwuid");
		exit(EXIT_FAILURE);
	}

	fin = fopen(input_filename, "r");
	if (fin == NULL)
	{
		perror("fopen");
		exit(EXIT_FAILURE);
	}
	bytes_read = fread(&buffer_len, sizeof(size_t), 1, fin);
	if (bytes_read != 1)
	{
		perror("fread");
		exit(EXIT_FAILURE);
	}
	fread(buffer, sizeof(char), buffer_len, fin);
	fclose(fin);

	snprintf(output_filename, sizeof(output_filename), "/submit/%s", pw->pw_name);
	fout = fopen(output_filename, "w");
	fchmod(fileno(fout), 0644);
	if (fout == NULL)
	{
		perror("fopen");
	}
	fprintf(fout, message, pw->pw_name, strlen(buffer), buffer);
	fclose(fout);

	return 0;
}
