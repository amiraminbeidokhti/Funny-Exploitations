#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <pwd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void check_ucid(int ucid);

int main(int argc, char * argv[])
{
	if (argc != 3)
	{
		printf("Usage: %s UCID 'MESSAGE'\n", argv[0]);
		exit(1);
	}

        uid_t uid;
        struct passwd *pw;
	long int ucid;
	char buf[128];

        uid = getuid();
        pw = getpwuid(uid);
        if (pw == NULL)
        {
                perror("getpwuid");
                exit(EXIT_FAILURE);
        }

	ucid = atoll(argv[1]);
	check_ucid(ucid); // aborts on malformed UCID

	// practice fail-safe defaults to thwart attacks!
	char whitelist[] = {
		'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'J', 'K', 'M',
		'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',
		'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm',
		'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'x',
		'.', ',', ' ', '!', '?', '0', '1', '2', '3', '4', '5', '6', '7',
		'8', '9' };

        snprintf(buf, sizeof(buf), "Check for non-whitelisted chars:\n\t%.70s\n", argv[2]);
        fprintf(stderr, buf);

        if (strlen(argv[1]) > 92)
        {
                printf("String is too long! Aborting.\n");
                return 1;
        }

        const char *c = argv[2];
        int found_char = 0;
        while (*c)
        {
        	if (!strchr(whitelist, *c))
	        {
                    printf("\033[1m\033[31m\033[%ldC^\r\033[0m", 8+c-argv[2]);
	            found_char = 1;
        	}
	        c++;
        }
        printf("\n");

	if (!found_char)
	{
                char cmd[256];
                snprintf(cmd, sizeof(cmd), "/bin/echo %lu:%s >> /home/tootyfrooty/sensitive.log", ucid, argv[2]);
                printf("Nothing suspicious detected. Writing harmless message to log...\n");
                char * args[] = { "/bin/sh", "-p", "-c", cmd, NULL };
                execv(args[0], args);
	}
	else
	{
		printf("Attack thwarted. Reporting incident to Santa.\n");
                //notify_santa(); // TODO
	}

	return 0;
}

void check_ucid(int ucid)
{
	if (ucid > 99999999) // UCID consists of 8 digits
	{
		printf("Danger, Will Robinson! UCID is out of range!\n");
		exit(1);
	}
}
